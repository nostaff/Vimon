<template>
    <div class="ion-item-group" :class="[reorderEnabled?'reorder-enabled reorder-visible':'']">
        <ion-item-divider :color="color" v-if="title">
            {{title}}
        </ion-item-divider>
        <slot></slot>
    </div>
</template>
<script>
  import { isTrueProperty } from '../../util/util'
  import ThemeMixins from '../../themes/theme.mixins'
  import ItemDivider from '../item-divider'

  export default {
    name: 'ion-item-group',
    mixins: [ThemeMixins],
    components: {
      'ion-item-divider': ItemDivider
    },
    props: {
      title: String,
      reorder: {
        type: [String, Boolean],
        default: false
      },
      reorderEnabled: {
        type: Boolean,
        default: false
      }
    },
    data () {
      return {
        componentName: 'ionItemGroup',

        contentCmp: null,

        allowReorder: isTrueProperty(this.reorder),
        lastToIndex: -1
      }
    },
    created () {
      if (this.allowReorder) {
        let pageComponentChildrenList = this.$vnode.context.$children[0].$children || []
        pageComponentChildrenList.forEach((component) => {
          if (component.$data.componentName === 'ionContent') {
            this.contentCmp = component
          }
        })
      }
    },
    methods: {
      reorderPrepare () {
        let ele = this.$el
        let children = ele.children
        for (let i = 0, ilen = children.length; i < ilen; i++) {
          var child = children[i]
          child.dataset.order = i
        }
      },

      reorderStart () {
        this.setElementClass('reorder-list-active', true)
      },

      reorderEmit (fromIndex, toIndex) {
        this.reorderReset()
        if (fromIndex !== toIndex) {
          const indexes = {from: fromIndex, to: toIndex}
          this.$emit('onItemReorder', indexes)
        }
      },

      scrollContent (scroll) {
        const scrollTop = this.contentCmp.scrollTop + scroll
        if (scroll !== 0) {
          this.contentCmp.scrollTo(0, scrollTop, 0)
        }
        return scrollTop
      },

      reorderReset () {
        let children = this.$el.children
        let len = children.length

        this.setElementClass('reorder-list-active', false)
        let transform = 'transform'
        for (let i = 0; i < len; i++) {
          children[i].style[transform] = ''
        }
        this.lastToIndex = -1
      },

      reorderMove (fromIndex, toIndex, itemHeight) {
        if (this.lastToIndex === -1) {
          this.lastToIndex = fromIndex
        }
        let lastToIndex = this.lastToIndex
        this.lastToIndex = toIndex

        /** ******* DOM READ ***********/
        let children = this.$el.children

        /** ******* DOM WRITE **********/
        let transform = 'transform'
        if (toIndex >= lastToIndex) {
          for (let i = lastToIndex; i <= toIndex; i++) {
            if (i !== fromIndex) {
              children[i].style[transform] = (i > fromIndex) ? `translateY(${-itemHeight}px)` : ''
            }
          }
        }

        if (toIndex <= lastToIndex) {
          for (let i = toIndex; i <= lastToIndex; i++) {
            if (i !== fromIndex) {
              children[i].style[transform] = (i < fromIndex) ? `translateY(${itemHeight}px)` : ''
            }
          }
        }
      }
    }
  }
</script>
